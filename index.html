<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô ‚Äì ‡∏Ñ‡∏£‡∏π‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≠‡∏ô</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Use Prompt font as the primary font */
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #FEFBF6; /* Creamy white background */
        }
        .grade-btn.active {
            background-color: #FBBF24; /* amber-400 */
            color: #78350F; /* amber-900 */
            font-weight: bold;
        }

        /* CSS for printing */
        @media print {
            .print-hide { display: none !important; }
            .print-show { display: block !important; }
            @page { size: A4; margin: 0.75in; }
            body { background-color: #ffffff; margin: 0; padding: 0; }
            .main-container { box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; max-width: 100%; }
            .summary-grid { grid-template-columns: 2fr 1fr; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Main App Container -->
    <div class="main-container container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">‡∏Ñ‡∏£‡∏π‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≠‡∏ô‚Ñ¢</h1>
            <p class="text-xl text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° VIP</p>
        </header>

        <!-- Header for Printing (Initially Hidden) -->
        <div class="print-show hidden mb-6 border-b pb-4">
            <h1 class="text-2xl font-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h1>
            <p class="text-lg">‡πÇ‡∏î‡∏¢: ‡∏Ñ‡∏£‡∏π‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≠‡∏ô‚Ñ¢</p>
            <div class="mt-2 text-sm">
                <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="printDate"></span></p>
            </div>
        </div>

        <!-- 1. Quick Grade Level Panel -->
        <fieldset class="my-4 p-4 border rounded-lg bg-white shadow-sm print-hide">
            <legend class="text-lg font-semibold px-2">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</legend>
            <div id="gradeSelectionPanel" class="grid grid-cols-3 gap-2 mt-2">
                <!-- Primary Lower -->
                <button type="button" class="grade-btn p-3 rounded-lg border bg-gray-100 hover:bg-gray-200 transition" onclick="selectGrade('p1')">‡∏õ.1</button>
                <button type="button" class="grade-btn p-3 rounded-lg border bg-gray-100 hover:bg-gray-200 transition" onclick="selectGrade('p2')">‡∏õ.2</button>
                <button type="button" class="grade-btn p-3 rounded-lg border bg-gray-100 hover:bg-gray-200 transition" onclick="selectGrade('p3')">‡∏õ.3</button>
                <!-- Primary Upper -->
                <button type="button" class="grade-btn p-3 rounded-lg border bg-gray-100 hover:bg-gray-200 transition" onclick="selectGrade('p4')">‡∏õ.4</button>
                <button type="button" class="grade-btn p-3 rounded-lg border bg-gray-100 hover:bg-gray-200 transition" onclick="selectGrade('p5')">‡∏õ.5</button>
                <button type="button" class="grade-btn p-3 rounded-lg border bg-gray-100 hover:bg-gray-200 transition" onclick="selectGrade('p6')">‡∏õ.6</button>
            </div>
        </fieldset>

        <!-- 2. Quick Subject Panel -->
        <fieldset class="my-4 p-4 border rounded-lg bg-white shadow-sm print-hide">
            <legend class="text-lg font-semibold px-2">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</legend>
            <div id="quickAddPanel" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mt-2">
                <!-- Checkboxes will be dynamically populated by JS -->
            </div>
        </fieldset>

        <!-- 3. VIP Service Panel -->
        <fieldset class="my-4 p-4 border rounded-lg bg-white shadow-sm print-hide">
            <legend class="text-lg font-semibold px-2">3. ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (VIP)</legend>
            <div class="mt-2">
                <div id="vipContainer" class="flex items-center p-3 border rounded-md hover:bg-gray-50 transition cursor-pointer" onclick="toggleVipCheckbox()">
                    <input type="checkbox" id="vipCheckbox" class="h-5 w-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-400 cursor-pointer" onchange="handleVipChange(this)">
                    <label for="vipCheckbox" class="ml-3 block text-gray-700 select-none cursor-pointer font-medium">
                        ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° VIP <span class="text-blue-600 font-bold ml-1">(299)</span>
                    </label>
                </div>
            </div>
        </fieldset>

        <!-- Review & Selected Items List -->
        <div id="reviewSection" class="mb-6 bg-white p-4 md:p-6 rounded-lg shadow-lg">
            <h2 id="reviewHeader" class="text-xl font-semibold mb-4">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div id="reviewListContainer" class="space-y-2">
                <p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
            </div>
        </div>

        <!-- Price Summary & Discounts -->
        <div class="mt-6 bg-white p-4 md:p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Discount Inputs -->
                <div class="space-y-4 print-hide">
                    <div>
                        <div class="flex justify-between">
                            <label for="discountPercent" class="block text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (%)</label>
                            <span id="autoDiscountBadge" class="hidden text-xs font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded-full">‡πÇ‡∏õ‡∏£‡∏Ø ‡∏Ñ‡∏£‡∏ö 3 ‡∏ß‡∏¥‡∏ä‡∏≤</span>
                        </div>
                        <input type="number" id="discountPercent" min="0" max="100" placeholder="0" oninput="recalcTotals(true)"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    </div>
                    <div>
                        <label for="discountBaht" class="block text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="discountBaht" min="0" placeholder="0" oninput="recalcTotals(true)"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">
                    </div>
                </div>
                <!-- Price Display -->
                <div class="summary-grid grid grid-cols-2 gap-x-4 gap-y-2 text-right bg-gray-50 p-4 rounded-lg md:col-start-2">
                    <span class="text-gray-600 text-left">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                    <span id="subtotalDisplay" class="font-semibold text-gray-800">0 ‡∏ö‡∏≤‡∏ó</span>

                    <span class="text-gray-600 text-left">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏à‡∏≤‡∏Å %):</span>
                    <span id="discountPercentValueDisplay" class="font-semibold text-red-600">- 0 ‡∏ö‡∏≤‡∏ó</span>

                    <span class="text-gray-600 text-left">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≤‡∏ó):</span>
                    <span id="discountBahtValueDisplay" class="font-semibold text-red-600">- 0 ‡∏ö‡∏≤‡∏ó</span>

                    <span class="text-left text-xl font-bold text-gray-900 border-t pt-2 mt-2 col-span-2"></span>
                    
                    <span class="text-left text-xl font-bold text-gray-900">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                    <span id="netTotalDisplay" class="text-right text-3xl font-bold text-blue-600">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>
        </div>

        <!-- Main Action Buttons -->
        <div class="mt-6 flex flex-col md:flex-row gap-4 print-hide">
            <button type="button" onclick="printQuote()"
                class="w-full bg-green-500 text-white font-semibold px-6 py-3 rounded-md hover:bg-green-600 transition-colors shadow-md">
                üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF
            </button>
            <button type="button" onclick="resetForm()"
                class="w-full bg-gray-400 text-white font-semibold px-6 py-3 rounded-md hover:bg-gray-500 transition-colors shadow-md">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
            </button>
        </div>

    </div>

    <script>
        // --- JavaScript Section ---

        // Main data configuration
        const priceTable = { 40: 200, 80: 250, 160: 300, 200: 350 };
        const vipPrice = 299;
        const AUTO_DISCOUNT_THRESHOLD = 3; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const AUTO_DISCOUNT_PERCENT = 5;  // ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

        // Helper to copy P3 config to P4-P6 easily (for existing subjects)
        const p3Base = [40, 80]; // fallback
        
        const subjectHoursConfig = {
            '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢': { 
                'p1': [200], 'p2': [200], 'p3': [160, 200]
            },
            '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏´‡∏•‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)': {
                'p4': [80], 'p5': [80]
            },
            '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ß‡∏£‡∏£‡∏ì‡∏Ñ‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏£‡∏£‡∏°)': {
                'p4': [80], 'p5': [80]
            },
            '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©': { 
                'p1': [160, 200], 'p2': [160, 200], 'p3': [160, 200]
            },
            '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': { 
                'p1': [200], 'p2': [200], 'p3': [200]
            },
            '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°': { 
                'p1': [40, 80], 'p2': [40, 80], 'p3': [40, 80]
            },
            '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°': { 
                'p4': [80], 'p5': [80], 'p6': [80] 
            },
            '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á': { 
                'p1': [40, 80], 'p2': [40, 80], 'p3': [40, 80]
            },
            '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': { 
                'p1': [40], 'p2': [40], 'p3': [40]
            },
            '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô': { 
                'p1': [40, 80], 'p2': [40, 80], 'p3': [40, 80]
            },
            '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏à‡∏¥‡∏ï': { 
                'p1': [40], 'p2': [40, 80], 'p3': [40, 80]
            },
            '‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏†‡∏≤‡∏û': { 
                'p1': [40, 80], 'p2': [40, 80], 'p3': [40, 80]
            },
            '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏â‡∏•‡∏≤‡∏î‡∏£‡∏π‡πâ': { 
                'p1': [40], 'p2': [40], 'p3': [40]
            },
            '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì': { 
                'p1': [40], 'p2': [40], 'p3': [40]
            },
            '‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤': { 
                'p1': [40], 'p2': [40], 'p3': [40]
            },
            '‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û': { 
                'p1': [40], 'p2': [40], 'p3': [40]
            },
            '‡∏î‡∏ô‡∏ï‡∏£‡∏µ-‡∏ô‡∏≤‡∏è‡∏®‡∏¥‡∏•‡∏õ‡πå': { 
                'p1': [40], 'p2': [40], 'p3': [40]
            }
        };

        // --- Application State ---
        let selectedItems = []; // This array holds the state of all chosen subjects
        let currentGrade = 'p1'; // Default selected grade
        let itemCounter = 0; // To give each item a unique ID for removal

        // --- DOM Elements ---
        const gradeSelectionPanel = document.getElementById('gradeSelectionPanel');
        const quickAddPanel = document.getElementById('quickAddPanel');
        const reviewListContainer = document.getElementById('reviewListContainer');
        const reviewHeader = document.getElementById('reviewHeader');
        const discountPercentInput = document.getElementById('discountPercent');
        const discountBahtInput = document.getElementById('discountBaht');
        const subtotalDisplay = document.getElementById('subtotalDisplay');
        const discountPercentValueDisplay = document.getElementById('discountPercentValueDisplay');
        const discountBahtValueDisplay = document.getElementById('discountBahtValueDisplay');
        const netTotalDisplay = document.getElementById('netTotalDisplay');
        const vipCheckbox = document.getElementById('vipCheckbox');
        const vipContainer = document.getElementById('vipContainer');
        const autoDiscountBadge = document.getElementById('autoDiscountBadge');

        // --- Helper Functions ---
        function formatCurrency(value) { return new Intl.NumberFormat('th-TH').format(Math.round(value)); }
        function getPrice(hours) { return priceTable[hours] || 0; }

        // --- Core Application Functions ---

        function selectGrade(grade) {
            currentGrade = grade;
            gradeSelectionPanel.querySelectorAll('.grade-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            populateSubjectPanel(grade);
        }

        function populateSubjectPanel(grade) {
            quickAddPanel.innerHTML = ''; 
            const gradeNum = grade.replace('p', ''); // Extract number (e.g. '1' from 'p1')
            for (const subject in subjectHoursConfig) {
                if (subjectHoursConfig[subject][grade]) {
                    const availableHours = subjectHoursConfig[subject][grade];
                    
                    availableHours.forEach(hour => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center p-2 border rounded-md hover:bg-gray-50 transition cursor-pointer';
                        div.onclick = (e) => {
                            if (e.target.type !== 'checkbox') {
                                const checkbox = div.querySelector('input[type="checkbox"]');
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        };

                        const id = `quickadd-${subject.replace(/\s+/g, '-')}-${hour}`;

                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = id;
                        input.value = subject;
                        input.dataset.hours = hour;
                        input.className = 'h-5 w-5 text-yellow-500 border-gray-300 rounded focus:ring-yellow-400 cursor-pointer';
                        
                        const isSelected = selectedItems.some(item => 
                            item.subject === subject && 
                            item.grade === currentGrade &&
                            item.hours === hour
                        );
                        input.checked = isSelected;
                        if (isSelected) div.classList.add('bg-yellow-50', 'border-yellow-200');

                        input.addEventListener('change', (e) => {
                             toggleSubject(e.target.checked, subject, currentGrade, hour);
                             if (e.target.checked) {
                                 div.classList.add('bg-yellow-50', 'border-yellow-200');
                             } else {
                                 div.classList.remove('bg-yellow-50', 'border-yellow-200');
                             }
                        });

                        const label = document.createElement('label');
                        label.htmlFor = id;
                        label.className = 'ml-2 block text-sm text-gray-700 select-none cursor-pointer flex-grow';
                        // Add grade number to the label
                        label.innerHTML = `${subject} ${gradeNum} <span class="text-xs text-gray-500">(${hour} ‡∏ä‡∏°.)</span>`;
                        
                        div.appendChild(input);
                        div.appendChild(label);
                        quickAddPanel.appendChild(div);
                    });
                }
            }
        }

        // --- VIP Functions ---
        function toggleVipCheckbox() {
            if (event.target.type !== 'checkbox') {
                vipCheckbox.checked = !vipCheckbox.checked;
                handleVipChange(vipCheckbox);
            }
        }

        function handleVipChange(checkbox) {
            const isChecked = checkbox.checked;
            if (isChecked) {
                vipContainer.classList.add('bg-yellow-50', 'border-yellow-200');
                selectedItems.push({
                    id: 'vip-item',
                    subject: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏° VIP',
                    grade: 'VIP',
                    hours: 0,
                    price: vipPrice
                });
            } else {
                vipContainer.classList.remove('bg-yellow-50', 'border-yellow-200');
                selectedItems = selectedItems.filter(item => item.id !== 'vip-item');
            }
            recalcTotals();
        }

        function toggleSubject(isChecked, subject, grade, hours) {
            hours = parseInt(hours);
            if (isChecked) {
                 itemCounter++;
                 selectedItems.push({
                    id: `item-${itemCounter}`,
                    subject: subject,
                    grade: grade,
                    hours: hours,
                    price: getPrice(hours)
                });
            } else {
                selectedItems = selectedItems.filter(item => 
                    !(item.subject === subject && item.grade === grade && item.hours === hours)
                );
            }
            recalcTotals();
        }

        function removeItem(itemId) {
            if (itemId === 'vip-item') {
                vipCheckbox.checked = false;
                vipContainer.classList.remove('bg-yellow-50', 'border-yellow-200');
                selectedItems = selectedItems.filter(item => item.id !== itemId);
                recalcTotals();
                return;
            }

            const itemToRemove = selectedItems.find(item => item.id === itemId);
            if (itemToRemove && itemToRemove.grade === currentGrade) {
                 selectedItems = selectedItems.filter(item => item.id !== itemId);
                 recalcTotals();
                 populateSubjectPanel(currentGrade);
            } else {
                selectedItems = selectedItems.filter(item => item.id !== itemId);
                recalcTotals();
            }
        }

        /**
         * Recalculates totals. 
         * @param {boolean} isManualInput - True if triggered by user typing in discount boxes.
         */
        function recalcTotals(isManualInput = false) {
            reviewListContainer.innerHTML = '';
            let subtotal = 0;
            const itemCount = selectedItems.length;

            // --- Auto Discount Logic ---
            // Only update discount percentage automatically if:
            // 1. User is NOT manually typing (isManualInput == false)
            // 2. Threshold is met
            if (!isManualInput) {
                const lessonPlanCount = selectedItems.filter(i => i.id !== 'vip-item').length;
                
                if (lessonPlanCount >= AUTO_DISCOUNT_THRESHOLD) {
                    discountPercentInput.value = AUTO_DISCOUNT_PERCENT;
                    autoDiscountBadge.classList.remove('hidden');
                } else {
                    // Less than threshold: hide badge, BUT DO NOT RESET VALUE (allow manual input)
                    autoDiscountBadge.classList.add('hidden');
                }
            } else {
                // Manual input: just check threshold for badge visibility logic only
                 const lessonPlanCount = selectedItems.filter(i => i.id !== 'vip-item').length;
                 if (lessonPlanCount >= AUTO_DISCOUNT_THRESHOLD) {
                     autoDiscountBadge.classList.remove('hidden');
                 } else {
                     autoDiscountBadge.classList.add('hidden');
                 }
            }
            // ---------------------------

            if (itemCount > 0) {
                reviewHeader.textContent = `‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏ß‡∏° ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
            } else {
                reviewHeader.textContent = '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            }

            if (itemCount === 0) {
                reviewListContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>';
            } else {
                const sortedItems = [...selectedItems].sort((a, b) => {
                    if (a.id === 'vip-item') return 1;
                    if (b.id === 'vip-item') return -1;
                    if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                    return a.subject.localeCompare(b.subject);
                });

                sortedItems.forEach(item => {
                    subtotal += item.price;
                    const gradeTextMap = { 
                        'p1': '‡∏õ.1', 'p2': '‡∏õ.2', 'p3': '‡∏õ.3',
                        'p4': '‡∏õ.4', 'p5': '‡∏õ.5', 'p6': '‡∏õ.6'
                    };
                    let displayText = '';
                    
                    if (item.id === 'vip-item') {
                        displayText = `<span class="font-bold text-blue-600">‚ö° ${item.subject}</span>`;
                    } else {
                        // Add grade number to the display name
                        const gradeNum = item.grade.replace('p', '');
                        displayText = `${item.subject} ${gradeNum} (${gradeTextMap[item.grade]}, ${item.hours} ‡∏ä‡∏°.)`;
                    }

                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'grid grid-cols-12 gap-2 items-center py-2 border-b last:border-b-0 text-sm';
                    reviewItem.innerHTML = `
                        <span class="col-span-8 md:col-span-9 text-gray-700">
                            ${displayText}
                        </span>
                        <span class="col-span-3 md:col-span-2 text-right font-medium text-gray-800">${formatCurrency(item.price)} ‡∏ö‡∏≤‡∏ó</span>
                        <div class="col-span-1 text-center print-hide">
                            <button class="text-red-500 hover:text-red-700" onclick="removeItem('${item.id}')" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    reviewListContainer.appendChild(reviewItem);
                });
            }

            const discountPercent = parseFloat(discountPercentInput.value) || 0;
            const discountBaht = parseFloat(discountBahtInput.value) || 0;
            const discountPercentValue = (subtotal * discountPercent) / 100;
            const totalAfterPercent = subtotal - discountPercentValue;
            const actualDiscountBaht = Math.min(totalAfterPercent, discountBaht);
            let netTotal = Math.max(0, totalAfterPercent - actualDiscountBaht);

            subtotalDisplay.textContent = `${formatCurrency(subtotal)} ‡∏ö‡∏≤‡∏ó`;
            discountPercentValueDisplay.textContent = `- ${formatCurrency(discountPercentValue)} ‡∏ö‡∏≤‡∏ó`;
            discountBahtValueDisplay.textContent = `- ${formatCurrency(actualDiscountBaht)} ‡∏ö‡∏≤‡∏ó`;
            netTotalDisplay.textContent = `${formatCurrency(netTotal)} ‡∏ö‡∏≤‡∏ó`;
        }
        
        function resetForm() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                location.reload();
            }
        }
        
        function printQuote() {
            const today = new Date();
            document.getElementById('printDate').textContent = today.toLocaleDateString('th-TH', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            window.print();
        }

        document.addEventListener('DOMContentLoaded', () => {
            gradeSelectionPanel.querySelector('.grade-btn').click(); 
            recalcTotals();
        });
    </script>
</body>
</html>